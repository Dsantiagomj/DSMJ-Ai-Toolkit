#!/usr/bin/env bash

# dsmj-ai-toolkit CLI
# Installation and management tool for Claude AI toolkit

set -euo pipefail

VERSION="1.0.0"
TOOLKIT_DIR="$HOME/.dsmj-ai-toolkit"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
info() {
    echo -e "${BLUE}ℹ${NC}  $1"
}

success() {
    echo -e "${GREEN}✓${NC}  $1"
}

warn() {
    echo -e "${YELLOW}⚠${NC}  $1"
}

error() {
    echo -e "${RED}✗${NC}  $1" >&2
}

# Check if running from source or installed
if [[ "$SCRIPT_DIR" == "$TOOLKIT_DIR"* ]]; then
    # Running from installed location
    SOURCE_DIR="$TOOLKIT_DIR"
else
    # Running from development/source
    SOURCE_DIR="$(dirname "$SCRIPT_DIR")"
fi

##############################################################################
# Command: install
##############################################################################
cmd_install() {
    info "Installing dsmj-ai-toolkit v${VERSION}..."

    if [[ -d "$TOOLKIT_DIR" ]]; then
        warn "Toolkit already installed at $TOOLKIT_DIR"
        read -p "Reinstall? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            info "Installation cancelled"
            return 0
        fi
        rm -rf "$TOOLKIT_DIR"
    fi

    # Create toolkit directory
    mkdir -p "$TOOLKIT_DIR"

    # Copy files to global location
    info "Copying files to $TOOLKIT_DIR..."
    cp -r "$SOURCE_DIR/templates" "$TOOLKIT_DIR/"
    cp -r "$SOURCE_DIR/agents" "$TOOLKIT_DIR/"
    cp -r "$SOURCE_DIR/skills" "$TOOLKIT_DIR/"
    cp -r "$SOURCE_DIR/bin" "$TOOLKIT_DIR/"

    # Make CLI executable
    chmod +x "$TOOLKIT_DIR/bin/dsmj-ai"

    # Add to PATH if not already there
    SHELL_CONFIG=""
    if [[ -f "$HOME/.zshrc" ]]; then
        SHELL_CONFIG="$HOME/.zshrc"
    elif [[ -f "$HOME/.bashrc" ]]; then
        SHELL_CONFIG="$HOME/.bashrc"
    fi

    if [[ -n "$SHELL_CONFIG" ]]; then
        if ! grep -q "dsmj-ai-toolkit" "$SHELL_CONFIG"; then
            echo "" >> "$SHELL_CONFIG"
            echo "# dsmj-ai-toolkit" >> "$SHELL_CONFIG"
            echo "export PATH=\"\$HOME/.dsmj-ai-toolkit/bin:\$PATH\"" >> "$SHELL_CONFIG"
            success "Added to PATH in $SHELL_CONFIG"
            warn "Run 'source $SHELL_CONFIG' or restart terminal to use 'dsmj-ai' command"
        else
            info "Already in PATH"
        fi
    fi

    success "Toolkit installed successfully!"
    info "Run 'dsmj-ai init' in your project directory to set up"
}

##############################################################################
# Command: init (interactive project setup)
##############################################################################
cmd_init() {
    info "Initializing dsmj-ai-toolkit for this project..."

    # Check for existing .claude directory
    local has_existing_claude=false
    local has_existing_mcp=false

    if [[ -d ".claude" ]]; then
        has_existing_claude=true

        # Check for existing MCP or other configurations
        if [[ -f ".claude/settings.json" ]] || [[ -f ".claude/mcp.json" ]] || [[ -f ".claude/config.json" ]]; then
            has_existing_mcp=true
        fi
    fi

    # If existing configs found, be careful
    if [[ "$has_existing_claude" = true ]]; then
        echo ""
        warn ".claude/ directory already exists"

        if [[ "$has_existing_mcp" = true ]]; then
            info "Detected existing configuration files (MCP servers, settings, etc.)"
            info "Toolkit will ONLY add:"
            echo "  - .claude/agents/ (symlinks to toolkit agents)"
            echo "  - .claude/skills/ (symlinks to toolkit skills)"
            echo "  - .claude/CLAUDE.md (if it doesn't exist)"
            echo ""
            info "Toolkit will NOT touch:"
            echo "  - .claude/settings.json"
            echo "  - .claude/mcp.json"
            echo "  - .claude/config.json"
            echo "  - Any other existing files"
            echo ""
        fi

        read -p "Continue with additive installation? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            info "Initialization cancelled"
            return 0
        fi
    fi

    # Create .claude subdirectories (won't overwrite existing .claude/)
    mkdir -p .claude/agents
    mkdir -p .claude/skills

    # Detect stack
    info "Detecting project stack..."
    detected_stack=$(detect_stack)

    echo ""
    echo "Detected stack: $detected_stack"
    echo ""

    # Interactive skill selection
    echo "Select skills to include:"
    declare -a selected_skills=()

    # Stack skills
    if echo "$detected_stack" | grep -q "React"; then
        selected_skills+=("react-19")
    fi
    if echo "$detected_stack" | grep -q "Next.js"; then
        selected_skills+=("nextjs-15")
    fi
    if echo "$detected_stack" | grep -q "Python"; then
        selected_skills+=("python-312")
    fi
    if echo "$detected_stack" | grep -q "TypeScript"; then
        selected_skills+=("typescript")
    fi

    # Always include security and context-monitor
    selected_skills+=("security")
    selected_skills+=("context-monitor")

    # Show selected skills
    info "Skills to be linked:"
    for skill in "${selected_skills[@]}"; do
        echo "  - $skill"
    done
    echo ""

    # Create symlinks for agents
    info "Linking agents..."
    ln -sf "$TOOLKIT_DIR/agents/code-writer.md" ".claude/agents/code-writer.md"
    success "Linked code-writer.md"

    ln -sf "$TOOLKIT_DIR/agents/code-reviewer.md" ".claude/agents/code-reviewer.md"
    success "Linked code-reviewer.md"

    ln -sf "$TOOLKIT_DIR/agents/planner.md" ".claude/agents/planner.md"
    success "Linked planner.md"

    ln -sf "$TOOLKIT_DIR/agents/git-docs.md" ".claude/agents/git-docs.md"
    success "Linked git-docs.md"

    ln -sf "$TOOLKIT_DIR/agents/qa.md" ".claude/agents/qa.md"
    success "Linked qa.md"

    ln -sf "$TOOLKIT_DIR/agents/devops.md" ".claude/agents/devops.md"
    success "Linked devops.md (optional)"

    # Create symlinks for skills
    info "Linking skills..."
    for skill in "${selected_skills[@]}"; do
        # Determine skill path
        skill_path=""
        if [[ -d "$TOOLKIT_DIR/skills/stack/$skill" ]]; then
            skill_path="$TOOLKIT_DIR/skills/stack/$skill"
        elif [[ -d "$TOOLKIT_DIR/skills/domain/$skill" ]]; then
            skill_path="$TOOLKIT_DIR/skills/domain/$skill"
        elif [[ -d "$TOOLKIT_DIR/skills/meta/$skill" ]]; then
            skill_path="$TOOLKIT_DIR/skills/meta/$skill"
        fi

        if [[ -n "$skill_path" ]]; then
            ln -sf "$skill_path" ".claude/skills/$skill"
            success "Linked $skill"
        else
            warn "Skill $skill not found"
        fi
    done

    # Generate CLAUDE.md from template (only if it doesn't exist)
    if [[ -f ".claude/CLAUDE.md" ]]; then
        warn "CLAUDE.md already exists, skipping generation"
        info "Your existing CLAUDE.md has been preserved"
        info "To regenerate, delete .claude/CLAUDE.md and run 'dsmj-ai init' again"
    else
        info "Generating CLAUDE.md..."
        generate_claude_md "$detected_stack"
        success "Created .claude/CLAUDE.md"
    fi

    # Success message
    echo ""
    success "Project initialized successfully!"
    echo ""
    info "Next steps:"
    if [[ ! -f ".claude/CLAUDE.md" ]] || [[ "$has_existing_mcp" = false ]]; then
        echo "  1. Review and customize .claude/CLAUDE.md"
        echo "  2. Start Claude Code in this directory"
        echo "  3. Try: 'Use maestro mode' for casual communication style"
    else
        echo "  1. Your existing MCP configurations are preserved"
        echo "  2. Toolkit agents and skills are now available"
        echo "  3. Start Claude Code in this directory"
        echo "  4. Try: 'Use maestro mode' for casual communication style"
    fi
    echo ""
}

##############################################################################
# Helper: Detect Stack
##############################################################################
detect_stack() {
    local stack=""

    # Check for package.json (Node.js projects)
    if [[ -f "package.json" ]]; then
        if grep -q '"next"' package.json; then
            stack+="Next.js, "
        fi
        if grep -q '"react"' package.json; then
            stack+="React, "
        fi
        if grep -q '"typescript"' package.json || [[ -f "tsconfig.json" ]]; then
            stack+="TypeScript, "
        fi
        if grep -q '"express"' package.json; then
            stack+="Express, "
        fi
    fi

    # Check for Python
    if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]] || [[ -f "Pipfile" ]]; then
        stack+="Python, "

        if grep -q "django" requirements.txt 2>/dev/null || grep -q "django" pyproject.toml 2>/dev/null; then
            stack+="Django, "
        fi
        if grep -q "fastapi" requirements.txt 2>/dev/null || grep -q "fastapi" pyproject.toml 2>/dev/null; then
            stack+="FastAPI, "
        fi
    fi

    # Check for Go
    if [[ -f "go.mod" ]]; then
        stack+="Go, "
    fi

    # Check for Rust
    if [[ -f "Cargo.toml" ]]; then
        stack+="Rust, "
    fi

    # Remove trailing comma and space
    stack="${stack%, }"

    if [[ -z "$stack" ]]; then
        stack="Unknown (no package.json, requirements.txt, or other markers found)"
    fi

    echo "$stack"
}

##############################################################################
# Helper: Generate CLAUDE.md
##############################################################################
generate_claude_md() {
    local stack="$1"
    local template="$TOOLKIT_DIR/templates/CLAUDE.md.template"
    local output=".claude/CLAUDE.md"

    # Copy template
    cp "$template" "$output"

    # Replace placeholders
    local date=$(date +%Y-%m-%d)

    # Use sed for replacements (macOS and Linux compatible)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        sed -i '' "s/\[e.g., Next.js 15, React 19, TypeScript, Prisma\]/$stack/" "$output"
        sed -i '' "s/\[Will be updated by installation wizard\]/$date/" "$output"
        sed -i '' "s/\[VERSION\]/$VERSION/" "$output"
        sed -i '' "s/\[DATE\]/$date/" "$output"
    else
        # Linux
        sed -i "s/\[e.g., Next.js 15, React 19, TypeScript, Prisma\]/$stack/" "$output"
        sed -i "s/\[Will be updated by installation wizard\]/$date/" "$output"
        sed -i "s/\[VERSION\]/$VERSION/" "$output"
        sed -i "s/\[DATE\]/$date/" "$output"
    fi
}

##############################################################################
# Command: sync (resync skills based on current stack)
##############################################################################
cmd_sync() {
    if [[ ! -d ".claude" ]]; then
        error "Not a dsmj-ai project. Run 'dsmj-ai init' first"
        exit 1
    fi

    info "Resyncing skills based on current stack..."

    detected_stack=$(detect_stack)
    info "Detected: $detected_stack"

    # Remove old skill symlinks
    find .claude/skills -type l -delete

    # Re-create based on detection (simplified - just use init logic)
    warn "Full sync not implemented yet. Run 'dsmj-ai init' to reinitialize"
}

##############################################################################
# Command: update (update global toolkit)
##############################################################################
cmd_update() {
    info "Updating dsmj-ai-toolkit..."

    if [[ ! -d "$TOOLKIT_DIR" ]]; then
        error "Toolkit not installed. Run 'dsmj-ai install' first"
        exit 1
    fi

    # For now, just reinstall
    # In production, this would pull from git/homebrew
    warn "Update command not fully implemented"
    info "To update, run: dsmj-ai install"
}

##############################################################################
##############################################################################

##############################################################################
# Command: status (show installation status)
##############################################################################
cmd_status() {
    echo "dsmj-ai-toolkit v${VERSION}"
    echo ""

    if [[ -d "$TOOLKIT_DIR" ]]; then
        success "Toolkit installed at $TOOLKIT_DIR"

        # Count agents and skills
        local agent_count=$(find "$TOOLKIT_DIR/agents" -name "*.md" 2>/dev/null | wc -l)
        local skill_count=$(find "$TOOLKIT_DIR/skills" -type f -name "SKILL.md" 2>/dev/null | wc -l)

        info "Agents available: $agent_count"
        info "Skills available: $skill_count"
    else
        warn "Toolkit not installed globally"
        info "Run 'dsmj-ai install' to install"
    fi

    echo ""

    if [[ -d ".claude" ]]; then
        success "Project initialized in current directory"

        local linked_agents=$(find .claude/agents -type l 2>/dev/null | wc -l)
        local linked_skills=$(find .claude/skills -type l 2>/dev/null | wc -l)

        info "Linked agents: $linked_agents"
        info "Linked skills: $linked_skills"
    else
        warn "Current directory not initialized"
        info "Run 'dsmj-ai init' to initialize"
    fi
}

##############################################################################
# Command: skills (skill management)
##############################################################################

# Skills catalog path
SKILLS_CATALOG="$TOOLKIT_DIR/.dsmj-ai/skills-catalog.json"

cmd_skills() {
    local subcommand="${1:-help}"
    shift || true

    case "$subcommand" in
        list)
            skills_list "$@"
            ;;
        search)
            skills_search "$@"
            ;;
        info)
            skills_info "$@"
            ;;
        install)
            skills_install "$@"
            ;;
        uninstall)
            skills_uninstall "$@"
            ;;
        help|--help|-h)
            skills_help
            ;;
        *)
            error "Unknown skills subcommand: $subcommand"
            echo ""
            skills_help
            exit 1
            ;;
    esac
}

skills_list() {
    local filter=""
    local show_installed=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --installed)
                show_installed=true
                shift
                ;;
            *)
                filter="$1"
                shift
                ;;
        esac
    done

    if [[ ! -f "$SKILLS_CATALOG" ]]; then
        error "Skills catalog not found"
        info "Run 'dsmj-ai install' to set up the toolkit"
        exit 1
    fi

    info "Available Skills:"
    echo ""

    # Use jq if available, otherwise use grep/awk
    if command -v jq &> /dev/null; then
        jq -r '.skills[] |
            select(
                (if $installed then .installed == true else true end) and
                (if $filter != "" then (.name | contains($filter)) or (.category | contains($filter)) or (.tags | map(. | contains($filter)) | any) else true end)
            ) |
            "\(.name)\t\(.displayName)\t\(.category)\t\(if .official then "⭐" else "" end)"' \
            --arg installed "$show_installed" \
            --arg filter "$filter" \
            "$SKILLS_CATALOG" | \
        while IFS=$'\t' read -r name display category official; do
            printf "  ${BLUE}%-35s${NC} ${GREEN}%s${NC} ${YELLOW}[%s]${NC} %s\n" "$name" "$display" "$category" "$official"
        done
    else
        warn "Install 'jq' for better formatting"
        cat "$SKILLS_CATALOG" | grep -E '"name"|"displayName"' | sed 'N;s/\n/ /'
    fi

    echo ""
    info "Use 'dsmj-ai skills info <name>' for details"
    info "Use 'dsmj-ai skills install <name>' to install"
}

skills_search() {
    local query="$1"

    if [[ -z "$query" ]]; then
        error "Usage: dsmj-ai skills search <keyword>"
        exit 1
    fi

    info "Searching for: $query"
    echo ""

    if command -v jq &> /dev/null; then
        local count=$(jq -r --arg q "$query" '[.skills[] |
            select(
                (.name | contains($q)) or
                (.displayName | contains($q)) or
                (.description | contains($q)) or
                (.category | contains($q)) or
                (.tags | map(. | contains($q)) | any)
            )] | length' "$SKILLS_CATALOG")

        if [[ "$count" -eq 0 ]]; then
            warn "No skills found matching '$query'"
            exit 0
        fi

        jq -r --arg q "$query" '.skills[] |
            select(
                (.name | contains($q)) or
                (.displayName | contains($q)) or
                (.description | contains($q)) or
                (.category | contains($q)) or
                (.tags | map(. | contains($q)) | any)
            ) |
            "\(.name)\t\(.displayName)\t\(.description)\t\(if .official then "⭐" else "" end)"' \
            "$SKILLS_CATALOG" | \
        while IFS=$'\t' read -r name display desc official; do
            echo -e "  ${BLUE}$name${NC} ${GREEN}$display${NC} $official"
            echo -e "    $desc"
            echo ""
        done

        success "Found $count skill(s)"
    else
        warn "Install 'jq' for search functionality"
        exit 1
    fi
}

skills_info() {
    local skill_name="$1"

    if [[ -z "$skill_name" ]]; then
        error "Usage: dsmj-ai skills info <skill-name>"
        exit 1
    fi

    if command -v jq &> /dev/null; then
        local skill_json=$(jq -r --arg name "$skill_name" '.skills[] | select(.name == $name)' "$SKILLS_CATALOG")

        if [[ -z "$skill_json" ]]; then
            error "Skill not found: $skill_name"
            info "Use 'dsmj-ai skills list' to see available skills"
            exit 1
        fi

        local display_name=$(echo "$skill_json" | jq -r '.displayName')
        local description=$(echo "$skill_json" | jq -r '.description')
        local category=$(echo "$skill_json" | jq -r '.category')
        local source=$(echo "$skill_json" | jq -r '.source')
        local compatibility=$(echo "$skill_json" | jq -r '.compatibility')
        local official=$(echo "$skill_json" | jq -r '.official')
        local agents=$(echo "$skill_json" | jq -r '.agents | join(", ")')
        local tags=$(echo "$skill_json" | jq -r '.tags | join(", ")')
        local installed=$(echo "$skill_json" | jq -r '.installed')

        echo ""
        echo -e "${BLUE}$skill_name${NC}"
        echo -e "${GREEN}$display_name${NC}"
        if [[ "$official" == "true" ]]; then
            echo -e "⭐ Official Anthropic Skill"
        fi
        echo ""
        echo "Description: $description"
        echo "Category:    $category"
        echo "Agents:      $agents"
        echo "Tags:        $tags"
        echo "Source:      $source"
        echo "Status:      $compatibility"
        if [[ "$installed" == "true" ]]; then
            echo -e "Installed:   ${GREEN}Yes${NC}"
        else
            echo -e "Installed:   ${YELLOW}No${NC}"
        fi
        echo ""
    else
        warn "Install 'jq' to view skill info"
        exit 1
    fi
}

skills_install() {
    local skill_name="$1"

    if [[ -z "$skill_name" ]]; then
        error "Usage: dsmj-ai skills install <skill-name>"
        exit 1
    fi

    # Check if current directory is a project
    if [[ ! -d ".claude" ]]; then
        error "Not a dsmj-ai project"
        info "Run 'dsmj-ai init' first or cd into a project directory"
        exit 1
    fi

    info "Installing skill: $skill_name"

    if command -v jq &> /dev/null; then
        local skill_json=$(jq -r --arg name "$skill_name" '.skills[] | select(.name == $name)' "$SKILLS_CATALOG")

        if [[ -z "$skill_json" ]]; then
            error "Skill not found: $skill_name"
            info "Use 'dsmj-ai skills list' to see available skills"
            exit 1
        fi

        local source=$(echo "$skill_json" | jq -r '.source')
        local display_name=$(echo "$skill_json" | jq -r '.displayName')

        # Check if already installed
        local installed=$(echo "$skill_json" | jq -r '.installed')
        if [[ "$installed" == "true" ]] && [[ -d ".claude/skills/$(basename $skill_name)" ]]; then
            warn "Skill already installed: $display_name"
            return 0
        fi

        mkdir -p ".claude/skills"

        info "Cloning from $source..."

        # Clone the skill repository
        local skill_dir=".claude/skills/$(basename $skill_name)"
        if git clone --depth 1 "$source" "$skill_dir" 2>/dev/null; then
            # Remove .git directory to save space
            rm -rf "$skill_dir/.git"

            success "Installed: $display_name"
            info "Skill available at: $skill_dir"
        else
            error "Failed to clone skill from $source"
            info "The repository may not exist or you may need to check your internet connection"
            exit 1
        fi
    else
        error "Install 'jq' to use skill management"
        exit 1
    fi
}

skills_uninstall() {
    local skill_name="$1"

    if [[ -z "$skill_name" ]]; then
        error "Usage: dsmj-ai skills uninstall <skill-name>"
        exit 1
    fi

    if [[ ! -d ".claude" ]]; then
        error "Not a dsmj-ai project"
        exit 1
    fi

    local skill_dir=".claude/skills/$(basename $skill_name)"

    if [[ ! -d "$skill_dir" ]]; then
        warn "Skill not installed: $skill_name"
        exit 0
    fi

    info "Uninstalling: $skill_name"
    rm -rf "$skill_dir"
    success "Uninstalled: $skill_name"
}

skills_help() {
    cat << EOF
dsmj-ai skills - Skill Management

USAGE:
    dsmj-ai skills <subcommand> [options]

SUBCOMMANDS:
    list [--installed]     List available skills
    search <keyword>       Search skills by keyword
    info <skill-name>      Show detailed skill information
    install <skill-name>   Install a skill to current project
    uninstall <skill-name> Uninstall a skill from current project
    help                   Show this help message

EXAMPLES:
    # List all available skills
    dsmj-ai skills list

    # Search for React skills
    dsmj-ai skills search react

    # Get info about a specific skill
    dsmj-ai skills info anthropics/react

    # Install a skill
    dsmj-ai skills install anthropics/react

    # Uninstall a skill
    dsmj-ai skills uninstall anthropics/react

EOF
}

##############################################################################
# Command: version
##############################################################################
cmd_version() {
    echo "dsmj-ai-toolkit v${VERSION}"
}

##############################################################################
# Command: help
##############################################################################
cmd_help() {
    cat << EOF
dsmj-ai-toolkit v${VERSION}

USAGE:
    dsmj-ai <command> [options]

COMMANDS:
    install     Install toolkit globally (~/.dsmj-ai-toolkit/)
    init        Initialize current project with interactive wizard
    skills      Manage community skills (list, search, install, uninstall)
    sync        Resync skills based on current stack (WIP)
    update      Update global toolkit (WIP)
    status      Show installation and project status
    version     Show version
    help        Show this help message

EXAMPLES:
    # First-time installation
    dsmj-ai install

    # Initialize a project
    cd my-project
    dsmj-ai init

    # Manage skills
    dsmj-ai skills list
    dsmj-ai skills search react
    dsmj-ai skills install anthropics/react

    # Check status
    dsmj-ai status

For more information, visit: https://github.com/dsantiagomj/dsmj-ai-toolkit
EOF
}

##############################################################################
# Main
##############################################################################
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        install)
            cmd_install
            ;;
        init)
            cmd_init
            ;;
        skills)
            cmd_skills "$@"
            ;;
        sync)
            cmd_sync
            ;;
        update)
            cmd_update
            ;;
        status)
            cmd_status
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            error "Unknown command: $command"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
